name: RDP / Tailscale / RustDesk - PC A

on:
  workflow_dispatch:
    inputs:
      authkey:
        description: "Tailscale Auth Key"
        required: true
        type: string

jobs:
  connect-pc-a:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 游댏 Generate PC Name + Random Password

      - name: Generate Password

on:
  workflow_dispatch:

jobs:
  generate-password:
    runs-on: windows-latest

    outputs:
      PASSWORD: ${{ steps.passgen.outputs.PASSWORD }}

    steps:
    - name: Generate Secure Password
      id: passgen
      shell: pwsh
      run: |
        function Generate-SecurePassword {
            param([int]$Length = 12)
            $bytes = New-Object 'System.Byte[]' $Length
            [System.Security.Cryptography.RandomNumberGenerator]::Create().GetBytes($bytes)
            return [Convert]::ToBase64String($bytes).Substring(0,$Length)
        }

        $password = Generate-SecurePassword
        echo "Generated password: $password"
        echo "PASSWORD=$password" >> $env:GITHUB_OUTPUT

    - name: Use Password
      shell: pwsh
      run: |
        echo "Password from previous step: ${{ needs.generate-password.outputs.PASSWORD }}"

    - name: Generate PC Name

on:
  workflow_dispatch:

jobs:
  pcname:
    runs-on: windows-latest

    outputs:
      PC_NAME: ${{ steps.pcgen.outputs.PC_NAME }}

    steps:
    - name: Generate Random PC Name
      id: pcgen
      shell: pwsh
      run: |
        # Generate PC Name - format: PC-XXXXX (letters + numbers)
        $pcname = "PC-" + (-join ((65..90) + (48..57) | Get-Random -Count 6 | ForEach-Object {[char]$_}))
        echo "PC Name: $pcname"
        echo "PC_NAME=$pcname" >> $env:GITHUB_OUTPUT

    - name: Use PC Name
      shell: pwsh
      run: |
        echo "Generated PC Name: ${{ needs.pcname.outputs.PC_NAME }}"
        
      # 游릭 Install Tailscale
      - name: Install Tailscale
        run: |
          choco install tailscale -y
          refreshenv

      # 游릭 Verify Tailscale
      - name: Verify Tailscale
        shell: powershell
        run: |
          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          if (Test-Path $ts) { & $ts version } else { Exit 1 }

      # 游릭 Connect to Tailscale (use generated hostname)
      - name: Connect Tailscale
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey="${{ github.event.inputs.authkey }}" `
            --hostname="${{ steps.gen.outputs.pcName }}"

      # 游릭 Install RustDesk IF missing
      - name: Install RustDesk
        shell: powershell
        run: |
          $rd = "C:\Program Files\RustDesk\rustdesk.exe"
          if (-Not (Test-Path $rd)) {
              choco install rustdesk -y
              refreshenv
          }

      # 游릭 Launch RustDesk
      - name: Run RustDesk
        run: |
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"

      - name: Done
        run: echo "PC-A connected via Tailscale & RustDesk started."
