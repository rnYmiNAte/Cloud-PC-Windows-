name: RDP / Tailscale / RustDesk - PC A

on:
  workflow_dispatch:
    inputs:
      authkey:
        description: 'Tailscale Auth Key'
        required: true
        type: string

jobs:
  connect-pc-a:
    runs-on: windows-latest

    steps:
      # 1) Get working files
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2) Load PC Specs from JSON
      - name: Load PC Specifications
        id: specs
        run: |
          $spec = Get-Content .\specification.json | ConvertFrom-Json
          echo "PC Name: $($spec.pc_a_name)"
          echo "::set-output name=pc_name::$($spec.pc_a_name)"

      # 3) Install Tailscale properly + refresh PATH
      - name: Install Tailscale
        run: |
          choco install tailscale -y
          refreshenv

      # 4) Ensure Tailscale works (fallback to full path)
      - name: Verify Tailscale Installation
        shell: powershell
        run: |
          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          if (Test-Path $ts) {
              Write-Host "Tailscale found at: $ts"
              & $ts version
          } else {
              Write-Error "Tailscale NOT FOUND! Installation may have failed."
              Exit 1
          }

      # 5) Connect via Tailscale
      - name: Connect Tailscale
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey="${{ github.event.inputs.authkey }}" `
            --hostname="${{ steps.specs.outputs.pc_name }}"

      # 6) Show Tailscale IP + Status
      - name: Check Tailscale Status
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" status
          & "C:\Program Files\Tailscale\tailscale.exe" ip

      # 7) Launch RustDesk
      - name: Launch RustDesk
        run: |
          $rd = "C:\Program Files\RustDesk\rustdesk.exe"
          if (Test-Path $rd) {
              Write-Host "Launching RustDesk..."
              Start-Process $rd
          } else {
              Write-Error "RustDesk NOT FOUND at $rd"
          }

      # 8) Done
      - name: Done
        run: echo "âœ… Successfully connected PC A via Tailscale & launched RustDesk!"
