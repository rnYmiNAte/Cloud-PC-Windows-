name: RDP-Tailscale-Rustdesk-A

on:
  workflow_dispatch:

jobs:
  setup-cloud-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Load Specifications
      run: |
        $spec = Get-Content specification.json | ConvertFrom-Json
        echo "OS: $($spec.os)"
        echo "CPU: $($spec.cpu)"
        echo "RAM: $($spec.ram)"
        echo "Storage: $($spec.storage)"
        echo "Renderer: $($spec.renderer)"
        echo "Network Speed: $($spec.network_speed)"

    - name: Generate Username and Password
      run: |
        $Username = "User_" + -join ((48..57) + (97..122) | Get-Random -Count 6 | % {[char]$_})
        $Password = -join ((33..126) | Get-Random -Count 12 | % {[char]$_})
        echo "USERNAME=$Username" >> $env:GITHUB_ENV
        echo "PASSWORD=$Password" >> $env:GITHUB_ENV

    - name: Display Credentials (Masked)
      run: |
        echo "Generated Username: $env:USERNAME"
        echo "Generated Password: ********"

    - name: Install Tailscale
      shell: pwsh
      run: |
        choco install tailscale -y
        $tsPath = "C:\Program Files\Tailscale"
        if (!(Test-Path $tsPath)) {
        Write-Error "Tailscale folder not found! Installation likely failed."
        exit 1
       }
        $env:PATH = "$tsPath;$env:PATH"
        tailscale version

- name: Tailscale Login
  shell: pwsh
  run: |
    tailscale up --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --accept-dns=false --accept-routes


    - name: Install Rustdesk
      run: |
        choco install rustdesk -y
        Start-Process "C:\Program Files\RustDesk\rustdesk.exe"

    - name: Enable RDP Access
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
